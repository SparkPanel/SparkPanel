# SparkPanel Nginx security snippet

# Rate limit per IP (tune as needed)
limit_req_zone $binary_remote_addr zone=sp_rpm:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=sp_conn:10m;

# Map for UA blocks (optional simple bot filter)
map $http_user_agent $is_bad_ua {
    default 0;
    ~*(curl|wget|python-requests|scrapy|bot|spider) 1;
}

# Include inside server {}

# Deny bad UA
if ($is_bad_ua) { return 403; }

# Limits
limit_req zone=sp_rpm burst=30 nodelay;
limit_conn sp_conn 50;

# Slowloris mitigation
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 20s;
send_timeout 10s;

# Size limits
client_max_body_size 20m;

# Security headers (adjust CSP for your domain)
add_header X-Frame-Options SAMEORIGIN always;
add_header X-Content-Type-Options nosniff always;
add_header Referrer-Policy strict-origin-when-cross-origin always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
# Example CSP (relax for your needs)
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' ws: wss: https:; frame-ancestors 'self';" always;
